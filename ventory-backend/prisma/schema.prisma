// Genera el cliente de Prisma para acceder a la base de datos
generator client {
  provider = "prisma-client-js"
}

// Fuente de datos principal. En este caso se utiliza SQLite y la URL se
// define mediante la variable de entorno DATABASE_URL
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Usuarios del sistema
model User {
  id            String   @id @default(cuid()) // identificador 煤nico
  name          String   // nombre del usuario
  email         String   @unique // correo electr贸nico
  password      String   // contrase帽a encriptada
  roleId        String?  // referencia opcional al rol
  role          Role?    @relation("RoleToUsers", fields: [roleId], references: [id]) // relaci贸n con Role
  companyId     String   // empresa a la que pertenece
  company       Company  @relation(fields: [companyId], references: [id]) // relaci贸n con Company
  status        String   @default("activo") // estado del usuario
  refreshToken  String?  @unique // token para refrescar sesi贸n
  createdAt     DateTime @default(now()) // fecha de creaci贸n
  updatedAt     DateTime @updatedAt // fecha de actualizaci贸n
}

// Empresas registradas
model Company {
  id                 String              @id @default(cuid()) // identificador 煤nico
  name               String              // nombre de la empresa
  slug               String              @unique // slug para URLs
  nit                String              @unique // n煤mero de identificaci贸n tributaria
  address            String?             // direcci贸n f铆sica
  phones             String?             // tel茅fonos de contacto
  email              String?             // correo de contacto
  website            String?             // sitio web
  logo               String?             // URL del logo

  currency           String?             // moneda predeterminada, ej: 'COP'
  vatPercent         Float?              // porcentaje de IVA est谩ndar

  country            String?             // Pa铆s de la empresa
  department         String?             // Departamento/Estado de la empresa
  city               String?             // Ciudad de la empresa

  //  Configuraci贸n de estilos de la empresa
  themePreset        String?             // preset del tema (Aura, Lara, Nora)
  themePrimary       String?             // color primario del tema
  themeSurface       String?             // color de superficie del tema
  menuMode           String?             // modo del men煤 (static, overlay)

  users              User[]              // usuarios asociados
  roles              Role[]              // roles asociados a esta empresa
  registrationTokens RegistrationToken[] // tokens de registro de usuarios
  listItems          ListItem[]          // relaci贸n con ListItem
  listTypes          ListType[]          // relaci贸n con ListType
  thirdParties       ThirdParty[]        // terceros asociados a esta empresa
  clients            Client[]            // clientes asociados a esta empresa
  providers          Provider[]          // proveedores asociados a esta empresa
  createdAt          DateTime            @default(now()) // fecha de creaci贸n
}

// Tokens de registro utilizados para invitar a nuevos usuarios
model RegistrationToken {
  id        String   @id @default(cuid()) // identificador 煤nico
  token     String   @unique // token 煤nico de invitaci贸n
  role      String   // rol que se asignar谩 al usuario
  companyId String   // empresa a la que pertenece
  company   Company  @relation(fields: [companyId], references: [id]) // relaci贸n con Company
  createdAt DateTime @default(now()) // fecha de creaci贸n
}

// Roles disponibles dentro de la aplicaci贸n
model Role {
  id          String       @id @default(cuid()) // identificador 煤nico
  name        String       // nombre del rol
  companyId   String       // empresa a la que pertenece
  company     Company      @relation(fields: [companyId], references: [id]) // relaci贸n con Company
  users       User[]       @relation("RoleToUsers") // usuarios que poseen este rol
  permissions Permission[] @relation("RoleToPermissions") // permisos asociados
  createdAt   DateTime     @default(now()) // fecha de creaci贸n
  updatedAt   DateTime     @updatedAt // fecha de actualizaci贸n

  @@unique([name, companyId]) // El nombre del rol debe ser 煤nico por empresa
}

// Permisos que pueden asociarse a los roles
model Permission {
  id        String   @id @default(cuid()) // identificador 煤nico
  name      String   @unique // nombre del permiso
  roles     Role[]   @relation("RoleToPermissions") // permisos asociados
  createdAt DateTime @default(now()) // fecha de creaci贸n
  updatedAt DateTime @updatedAt // fecha de actualizaci贸n
}

// Elementos de las listas personalizadas
model ListItem {
  id          String   @id @default(cuid()) // identificador 煤nico
  listTypeId  String   // referencia al tipo de lista
  listType    ListType @relation(fields: [listTypeId], references: [id]) // relaci贸n con ListType
  name        String   // nombre del elemento
  description String?  // descripci贸n opcional
  companyId   String   // empresa a la que pertenece
  company     Company  @relation(fields: [companyId], references: [id]) // relaci贸n con Company
  active      Boolean  @default(true) // indica si est谩 activo
  createdAt   DateTime @default(now()) // fecha de creaci贸n
  updatedAt   DateTime @updatedAt // fecha de actualizaci贸n

  @@index([listTypeId])
  @@index([companyId])
}

// Tipos de listas personalizables por cada compa帽铆a
model ListType {
  id          String     @id @default(cuid()) // identificador 煤nico
  code        String?    // c贸digo opcional
  name        String     // nombre del tipo de lista
  description String?    // descripci贸n opcional
  items       ListItem[] // elementos pertenecientes a este tipo
  companyId   String     // empresa propietaria
  company     Company    @relation(fields: [companyId], references: [id]) // relaci贸n con Company
  createdAt   DateTime   @default(now()) // fecha de creaci贸n
  updatedAt   DateTime   @updatedAt // fecha de actualizaci贸n

  @@index([companyId])
}

// Modelo central con datos compartidos
model ThirdParty {
  id        String   @id @default(cuid())
  name      String
  nit       String   // Documento de identificaci贸n
  address   String?
  phones    String?
  email     String?  @unique
  website   String?

  // Relaci贸n con la empresa (Multi-tenant)
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Relaciones de Rol (Opcionales, One-to-One)
  client   Client?
  provider Provider?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([nit, companyId]) // El NIT debe ser 煤nico por empresa
  @@map("third_parties")
}

// Rol: Cliente
model Client {
  id           String    @id @default(cuid())
  creditLimit  Float     @default(0)
  // Campos futuros: contactPerson, salesAgentId, etc.

  // Relaci贸n One-to-One con ThirdParty
  thirdPartyId String      @unique
  thirdParty   ThirdParty  @relation(fields: [thirdPartyId], references: [id], onDelete: Cascade)

  // Redundancia controlada para queries directas
  companyId    String
  company      Company     @relation(fields: [companyId], references: [id], onDelete: NoAction)

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

// Rol: Proveedor
model Provider {
  id             String    @id @default(cuid())
  paymentTerms   String?   // Ej: "Net 30", "Net 60"
  bankAccount    String?
  // Campos futuros: contactPerson, rating, etc.

  // Relaci贸n One-to-One con ThirdParty
  thirdPartyId   String      @unique
  thirdParty     ThirdParty  @relation(fields: [thirdPartyId], references: [id], onDelete: Cascade)
  
  // Redundancia controlada para queries directas
  companyId      String
  company        Company     @relation(fields: [companyId], references: [id], onDelete: NoAction)

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}