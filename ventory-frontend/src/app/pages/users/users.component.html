<p-toolbar styleClass="mb-6">
  <ng-template #start>
    <p-button label="Nuevo" icon="pi pi-plus" severity="secondary" class="mr-2" (click)="showTokenDialog()" />
    <p-button severity="secondary" label="Eliminar" icon="pi pi-trash" outlined (onClick)="deleteSelectedUsers()" [disabled]="!selectedUsers || !selectedUsers.length" />
  </ng-template>

</p-toolbar>


<p-table
  #dt
  [value]="users"
  [rows]="10"
  [columns]="cols"
  [paginator]="true"
  [globalFilterFields]="['name', 'email', 'role', 'status']"
  [tableStyle]="{ 'min-width': '75rem' }"
  [(selection)]="selectedUsers"
  [rowHover]="true"
  dataKey="id"
  currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
  [showCurrentPageReport]="true"
  [rowsPerPageOptions]="[10, 20, 30]"
>
  <ng-template #caption>
    <div class="flex items-center justify-between">
      <h5 class="m-0">Administrar Usuarios</h5>
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..." />
      </p-iconfield>
    </div>
  </ng-template>

  <ng-template #header>
    <tr>
      <th style="width: 3rem">
        <p-tableHeaderCheckbox />
      </th>
      <th style="min-width: 16rem">Nombre</th>
      <th style="min-width: 16rem">Correo</th>
      <th style="min-width: 12rem">Rol</th>
      <th style="min-width: 12rem">Estado</th>
      <th style="min-width: 12rem"></th>
    </tr>
  </ng-template>

  <ng-template #body let-user>
    <tr>
      <td style="width: 3rem">
        <p-tableCheckbox [value]="user" />
      </td>
      <td>{{ user.name }}</td>
      <td>{{ user.email }}</td>
      <td>{{ user.role }}</td>
      <td>
        <p-tag [value]="user.status" [severity]="getStatusSeverity(user.status)" />
      </td>
      <td>
        <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" (click)="editUser(user)" />
        <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deleteUser(user)" />
      </td>
    </tr>
  </ng-template>
</p-table>


<p-dialog [(visible)]="userDialog" [style]="{ width: '450px' }" header="Detalles del Usuario" [modal]="true">
  <ng-template #content>
    <div class="flex flex-col gap-6">
      <div>
        <label for="name" class="block font-bold mb-3">Nombre</label>
        <input type="text" pInputText id="name" [(ngModel)]="user.name" required autofocus fluid />
        <small class="text-red-500" *ngIf="submitted && !user.name">El nombre es obligatorio.</small>
      </div>

      <div>
        <label for="email" class="block font-bold mb-3">Correo</label>
        <input type="email" pInputText id="email" [(ngModel)]="user.email" required fluid />
        <small class="text-red-500" *ngIf="submitted && !user.email">El correo es obligatorio.</small>
      </div>

      <div>
        <label for="role" class="block font-bold mb-3">Rol</label>
        <p-dropdown
          id="role"
          [options]="roles"
          [(ngModel)]="user.role"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecciona un rol"
          fluid
        />
      </div>

      <div>
        <label for="status" class="block font-bold mb-3">Estado</label>
        <p-dropdown
          id="status"
          [options]="statuses"
          [(ngModel)]="user.status"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecciona un estado"
          fluid
        />
      </div>
    </div>
  </ng-template>

  <ng-template #footer>
    <p-button label="Cancelar" icon="pi pi-times" text (click)="hideDialog()" />
    <p-button label="Guardar" icon="pi pi-check" (click)="saveUser()" />
  </ng-template>
</p-dialog>

<p-dialog
    [(visible)]="displayTokenDialog"
    [style]="{ width: '400px' }"
    header="Generar Token de Usuario"
    [modal]="true"
    [closable]="true"
    (onHide)="closeTokenDialog()"
>
    <form [formGroup]="tokenForm">
        <div class="flex flex-col gap-4 p-4">
            <div>
                <label for="role" class="block font-bold mb-2">Rol</label>
                <p-dropdown
                    id="role"
                    [options]="roles"
                    formControlName="role"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Selecciona un rol"
                    fluid
                ></p-dropdown>
            </div>

            <div *ngIf="generatedToken" class="flex flex-col gap-2">
                <label class="block font-bold">Token Generado:</label>
                <input pInputText [value]="generatedToken" readonly />
                <p-button label="Copiar Token" icon="pi pi-copy" (click)="copyToken()" text />
            </div>
        </div>
    </form>

    <ng-template #footer>
        <div class="flex justify-end gap-2 p-4">
            <p-button label="Cancelar" icon="pi pi-times" text (click)="closeTokenDialog()" />
            <p-button label="Generar Token" icon="pi pi-check" (click)="generateToken()" [disabled]="!tokenForm.valid" />
        </div>
    </ng-template>
</p-dialog>
<p-confirmdialog [style]="{ width: '450px' }" />


