<!-- Barra de acciones principales -->
<p-toolbar styleClass="mb-6">
  <ng-template #start>
    <p-button label="Nueva Lista" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
    <p-button
        *ngIf="!showDelete()"
        severity="secondary"
        label="Eliminar"
        icon="pi pi-trash"
        outlined
        (onClick)="deleteSelectedItems()"
        [disabled]="!selectedItems || !selectedItems.length"
    />
    <p-button
        *ngIf="showDelete()"
        severity="secondary"
        label="Restaurar"
        icon="pi pi-replay"
        outlined
        (onClick)="restoreSelectedItems()"
        [disabled]="!selectedItems || !selectedItems.length"
    />
  </ng-template>
  <ng-template #end>
    <p-iconfield>
      <p-inputicon styleClass="pi pi-search" />
      <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..." />
    </p-iconfield>
  </ng-template>
</p-toolbar>

<!-- Tabla de ítems de lista -->
<p-table
  #dt
  [value]="listItems"
  [paginator]="true"
  [rows]="10"
  [globalFilterFields]="['name', 'description', 'listType.name']"
  [(selection)]="selectedItems"
  [rowHover]="true"
  dataKey="id"
  [rowsPerPageOptions]="[10, 20, 30]"
  [tableStyle]="{ 'min-width': '65rem' }"
>
  <!-- Cabecera de la tabla -->
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 3rem"><p-tableHeaderCheckbox /></th>
      <th style="min-width: 14rem">Nombre</th>
      <th style="min-width: 18rem">Descripción</th>
      <th style="min-width: 12rem">Tipo</th>
      <th style="min-width: 8rem"></th>
    </tr>
  </ng-template>

  <!-- Filtros por columna -->
  <ng-template pTemplate="filter">
    <tr>
      <th></th>
      <th>
        <input
          #filterNombre
          pInputText
          type="text"
          (input)="dt.filter(filterNombre.value, 'name', 'contains')"
          placeholder="Filtrar..."
          class="p-column-filter"
        />
      </th>
      <th>
        <input
          #filterDescripcion
          pInputText
          type="text"
          (input)="dt.filter(filterDescripcion.value, 'description', 'contains')"
          placeholder="Filtrar..."
          class="p-column-filter"
        />
      </th>
      <th>
        <input
          #filterTipo
          pInputText
          type="text"
          (input)="dt.filter(filterTipo.value, 'listType.name', 'contains')"
          placeholder="Filtrar..."
          class="p-column-filter"
        />
      </th>
      <th></th>
    </tr>
  </ng-template>

  <!-- Cuerpo de la tabla -->
  <ng-template pTemplate="body" let-item>
    <tr>
      <td style="width: 3rem">
        <p-tableCheckbox [value]="item" />
      </td>
      <td>{{ item.name }}</td>
      <td>{{ item.description }}</td>
      <td>
        <p-tag [value]="item.listType?.name" />
      </td>
      <td>
        <p-button
            icon="pi pi-pencil"
            class="mr-2"
            [rounded]="true"
            [outlined]="true"
            (click)="openEdit(item)"
            *ngIf="!showDelete()"
        />
        <p-button
            icon="pi pi-trash"
            severity="danger"
            [rounded]="true"
            [outlined]="true"
            (click)="delete(item)"
            *ngIf="!showDelete()"
        />
        <p-button
            icon="pi pi-replay"
            severity="success"
            [rounded]="true"
            [outlined]="true"
            (click)="restore(item)"
            *ngIf="showDelete()"
        />
      </td>
    </tr>
  </ng-template>
</p-table>


<!-- Diálogo principal para crear o editar un ítem -->
<p-dialog
    [(visible)]="displayDialog"
    [style]="{ width: '420px' }"
    [modal]="true"
    header="{{ isEdit ? 'Editar' : 'Nueva' }} Lista"
>
    <form [formGroup]="listItemForm" (ngSubmit)="save()" class="flex flex-col gap-6">
        <!-- Selector de tipo y botón para crear uno nuevo -->
        <div class="flex items-center gap-2 mb-4">
            <p-dropdown
                [options]="listTypes"
                formControlName="listTypeId"
                optionLabel="name"
                optionValue="id"
                placeholder="Seleccione tipo de lista"
                class="w-full"
            ></p-dropdown>
            <button
                pButton
                icon="pi pi-plus"
                outlined
                type="button"
                (click)="typeDialogVisible = true"
                [style.width.px]="40"
                [style.height.px]="40"
                title="Agregar nuevo tipo de lista"
            ></button>
        </div>

        <!-- Campos de nombre y descripción del ítem -->
        <div>
            <label class="block font-bold mb-2">Nombre</label>
            <input pInputText formControlName="name" class="w-full" />
        </div>
        <div>
            <label class="block font-bold mb-2">Descripción</label>
            <textarea pTextarea formControlName="description" id="description" [autoResize]="true" rows="3" cols="43"></textarea>
        </div>

        <!-- Tabla interna para administrar tipos de lista -->
        <div>
            <h3 class="font-bold mb-2 mt-6">Tipos de Lista</h3>
            <p-table [value]="listTypes" [paginator]="true" [rows]="3">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Nombre</th>
                        <th>Acciones</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-type>
                    <tr>
                        <td>{{ type.name }}</td>
                        <td>
                            <button pButton icon="pi pi-pencil" class="p-button-sm p-button-text" (click)="editType(type)"></button>
                            <button pButton icon="pi pi-trash" class="p-button-sm p-button-danger p-button-text" (click)="deleteType(type)"></button>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </form>

    <!-- Diálogo para crear/editar tipos de lista -->
    <p-dialog 
        header="{{ typeForm.get('id')?.value ? 'Editar' : 'Nuevo' }} Tipo de Lista" 
        [(visible)]="typeDialogVisible" 
        [modal]="true"
        [style]="{ width: '450px' }"
        [draggable]="false"
        [resizable]="false"
    >
        <form [formGroup]="typeForm" (ngSubmit)="saveType()" class="p-fluid">
            <div class="field">
                <label for="name" class="block font-bold mb-2">Nombre *</label>
                <input 
                    id="name" 
                    type="text" 
                    pInputText 
                    formControlName="name" 
                    class="w-full" 
                    autofocus
                    [ngClass]="{ 'p-invalid': typeForm.get('name')?.invalid && typeForm.get('name')?.touched }"
                />
                <small *ngIf="typeForm.get('name')?.invalid && typeForm.get('name')?.touched" class="p-error">
                    El nombre es requerido
                </small>
            </div>

            <div class="field">
                <label for="code" class="block font-bold mb-2">Código</label>
                <input 
                    id="code" 
                    type="text" 
                    pInputText 
                    formControlName="code" 
                    class="w-full"
                />
            </div>

            <div class="field">
                <label for="description" class="block font-bold mb-2">Descripción</label>
                <textarea 
                    id="description" 
                    pInputTextarea 
                    formControlName="description" 
                    class="w-full"
                    [rows]="3"
                    [autoResize]="true"
                ></textarea>
            </div>

            <div class="flex justify-content-end gap-2 mt-4">
                <button 
                    pButton 
                    type="button" 
                    label="Cancelar" 
                    icon="pi pi-times" 
                    class="p-button-text"
                    (click)="typeDialogVisible = false"
                ></button>
                <button 
                    pButton 
                    type="submit" 
                    label="Guardar" 
                    icon="pi pi-check" 
                    [disabled]="typeForm.invalid"
                ></button>
            </div>
        </form>
    </p-dialog>

    <!-- Pie del diálogo con los botones de acción -->
    <ng-template #footer>
        <div class="flex justify-end gap-2 w-full">
            <p-button label="Cancelar" icon="pi pi-times" text (click)="displayDialog = false"></p-button>
            <p-button label="Guardar" icon="pi pi-check" (click)="save()" [disabled]="listItemForm.invalid"></p-button>
        </div>
    </ng-template>

    <!-- Diálogo secundario para crear un tipo de lista -->
    <p-dialog
        [(visible)]="typeDialogVisible"
        header="Nuevo Tipo de Lista"
        [modal]="true"
        [closable]="true"
        [dismissableMask]="true"
        [style]="{ width: '400px' }"
    >
        <form [formGroup]="typeForm" (ngSubmit)="saveType()">
            <div class="card flex flex-col gap-4">
                <div class="flex flex-col gap-2">
                    <label for="name">Nombre</label>
                    <input pInputText formControlName="name" id="name" type="text" />
                </div>
                <div class="flex flex-col gap-2">
                    <label for="description">Descripción</label>
                    <textarea pTextarea formControlName="description" id="description" [autoResize]="true" rows="3" cols="30"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <p-button label="Cancelar" icon="pi pi-times" text (click)="typeDialogVisible = false"></p-button>
                <p-button label="Guardar" icon="pi pi-check" type="submit" [disabled]="typeForm.invalid"></p-button>
            </div>
        </form>
    </p-dialog>
</p-dialog>
<!-- Diálogo de confirmación para acciones de borrado -->
<p-confirmdialog [style]="{ width: '450px' }" />

